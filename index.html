                        <label for="empty-quantity-6">數量6</label>
                        <input type="number" id="empty-quantity-6" pattern="[0-9]*" inputmode="numeric" placeholder="0">
                    </div>

                    <!-- 第三組 -->
                    <div class="form-group">
                        <label for="empty-category-7">類別7</label>
                        <select id="empty-category-7">
                            <option value="">請選擇類別</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="empty-vehicle-7">載具簡稱7</label>
                        <input type="text" id="empty-vehicle-7" list="vehicle-types" placeholder="請選擇或輸入關鍵字搜尋">
                    </div>
                    
                    <div class="form-group">
                        <label for="empty-quantity-7">數量7</label>
                        <input type="number" id="empty-quantity-7" pattern="[0-9]*" inputmode="numeric" placeholder="0">
                    </div>

                    <!-- 第四組 -->
                    <div class="form-group">
                        <label for="empty-category-8">類別8</label>
                        <select id="empty-category-8">
                            <option value="">請選擇類別</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="empty-vehicle-8">載具簡稱8</label>
                        <input type="text" id="empty-vehicle-8" list="vehicle-types" placeholder="請選擇或輸入關鍵字搜尋">
                    </div>
                    
                    <div class="form-group">
                        <label for="empty-quantity-8">數量8</label>
                        <input type="number" id="empty-quantity-8" pattern="[0-9]*" inputmode="numeric" placeholder="0">
                    </div>

                    <!-- 展開按鈕 -->
                    <button type="button" class="expand-button" id="expand-empty-btn">
                        ▼ 展開更多組別
                    </button>

                    <!-- 可展開的區域 -->
                    <div class="expandable-section" id="empty-expandable">
                        <!-- 第二組 -->
                        <div class="group-title">第二組</div>
                        <div class="form-group">
                            <label for="empty-category-9">類別9</label>
                            <select id="empty-category-9">
                                <option value="">請選擇類別</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-vehicle-9">載具簡稱9</label>
                            <input type="text" id="empty-vehicle-9" list="vehicle-types" placeholder="請選擇或輸入關鍵字搜尋">
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-quantity-9">數量9</label>
                            <input type="number" id="empty-quantity-9" pattern="[0-9]*" inputmode="numeric" placeholder="0">
                        </div>

                        <div class="form-group">
                            <label for="empty-category-10">類別10</label>
                            <select id="empty-category-10">
                                <option value="">請選擇類別</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-vehicle-10">載具簡稱10</label>
                            <input type="text" id="empty-vehicle-10" list="vehicle-types" placeholder="請選擇或輸入關鍵字搜尋">
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-quantity-10">數量10</label>
                            <input type="number" id="empty-quantity-10" pattern="[0-9]*" inputmode="numeric" placeholder="0">
                        </div>

                        <div class="form-group">
                            <label for="empty-category-11">類別11</label>
                            <select id="empty-category-11">
                                <option value="">請選擇類別</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-vehicle-11">載具簡稱11</label>
                            <input type="text" id="empty-vehicle-11" list="vehicle-types" placeholder="請選擇或輸入關鍵字搜尋">
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-quantity-11">數量11</label>
                            <input type="number" id="empty-quantity-11" pattern="[0-9]*" inputmode="numeric" placeholder="0">
                        </div>

                        <div class="form-group">
                            <label for="empty-category-12">類別12</label>
                            <select id="empty-category-12">
                                <option value="">請選擇類別</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-vehicle-12">載具簡稱12</label>
                            <input type="text" id="empty-vehicle-12" list="vehicle-types" placeholder="請選擇或輸入關鍵字搜尋">
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-quantity-12">數量12</label>
                            <input type="number" id="empty-quantity-12" pattern="[0-9]*" inputmode="numeric" placeholder="0">
                        </div>

                        <!-- 第三組 -->
                        <div class="group-title">第三組</div>
                        <div class="form-group">
                            <label for="empty-category-13">類別13</label>
                            <select id="empty-category-13">
                                <option value="">請選擇類別</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-vehicle-13">載具簡稱13</label>
                            <input type="text" id="empty-vehicle-13" list="vehicle-types" placeholder="請選擇或輸入關鍵字搜尋">
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-quantity-13">數量13</label>
                            <input type="number" id="empty-quantity-13" pattern="[0-9]*" inputmode="numeric" placeholder="0">
                        </div>

                        <div class="form-group">
                            <label for="empty-category-14">類別14</label>
                            <select id="empty-category-14">
                                <option value="">請選擇類別</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-vehicle-14">載具簡稱14</label>
                            <input type="text" id="empty-vehicle-14" list="vehicle-types" placeholder="請選擇或輸入關鍵字搜尋">
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-quantity-14">數量14</label>
                            <input type="number" id="empty-quantity-14" pattern="[0-9]*" inputmode="numeric" placeholder="0">
                        </div>

                        <div class="form-group">
                            <label for="empty-category-15">類別15</label>
                            <select id="empty-category-15">
                                <option value="">請選擇類別</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-vehicle-15">載具簡稱15</label>
                            <input type="text" id="empty-vehicle-15" list="vehicle-types" placeholder="請選擇或輸入關鍵字搜尋">
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-quantity-15">數量15</label>
                            <input type="number" id="empty-quantity-15" pattern="[0-9]*" inputmode="numeric" placeholder="0">
                        </div>

                        <div class="form-group">
                            <label for="empty-category-16">類別16</label>
                            <select id="empty-category-16">
                                <option value="">請選擇類別</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-vehicle-16">載具簡稱16</label>
                            <input type="text" id="empty-vehicle-16" list="vehicle-types" placeholder="請選擇或輸入關鍵字搜尋">
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-quantity-16">數量16</label>
                            <input type="number" id="empty-quantity-16" pattern="[0-9]*" inputmode="numeric" placeholder="0">
                        </div>

                        <!-- 第四組 -->
                        <div class="group-title">第四組</div>
                        <div class="form-group">
                            <label for="empty-category-17">類別17</label>
                            <select id="empty-category-17">
                                <option value="">請選擇類別</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-vehicle-17">載具簡稱17</label>
                            <input type="text" id="empty-vehicle-17" list="vehicle-types" placeholder="請選擇或輸入關鍵字搜尋">
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-quantity-17">數量17</label>
                            <input type="number" id="empty-quantity-17" pattern="[0-9]*" inputmode="numeric" placeholder="0">
                        </div>

                        <div class="form-group">
                            <label for="empty-category-18">類別18</label>
                            <select id="empty-category-18">
                                <option value="">請選擇類別</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-vehicle-18">載具簡稱18</label>
                            <input type="text" id="empty-vehicle-18" list="vehicle-types" placeholder="請選擇或輸入關鍵字搜尋">
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-quantity-18">數量18</label>
                            <input type="number" id="empty-quantity-18" pattern="[0-9]*" inputmode="numeric" placeholder="0">
                        </div>

                        <div class="form-group">
                            <label for="empty-category-19">類別19</label>
                            <select id="empty-category-19">
                                <option value="">請選擇類別</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-vehicle-19">載具簡稱19</label>
                            <input type="text" id="empty-vehicle-19" list="vehicle-types" placeholder="請選擇或輸入關鍵字搜尋">
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-quantity-19">數量19</label>
                            <input type="number" id="empty-quantity-19" pattern="[0-9]*" inputmode="numeric" placeholder="0">
                        </div>

                        <div class="form-group">
                            <label for="empty-category-20">類別20</label>
                            <select id="empty-category-20">
                                <option value="">請選擇類別</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-vehicle-20">載具簡稱20</label>
                            <input type="text" id="empty-vehicle-20" list="vehicle-types" placeholder="請選擇或輸入關鍵字搜尋">
                        </div>
                        
                        <div class="form-group">
                            <label for="empty-quantity-20">數量20</label>
                            <input type="number" id="empty-quantity-20" pattern="[0-9]*" inputmode="numeric" placeholder="0">
                        </div>
                    </div>
                </div>

                <datalist id="vehicle-types"></datalist>
                
                <div class="button-group">
                    <button id="submit-btn">提交</button>
                    <button id="reset-btn">重設</button>
                </div>
                <p id="form-message" class="message"></p>
                <p id="form-error" class="error-message"></p>
                <p class="designer-info">Designed by T.C.C.管理本部</p>
            </div>
            
            <div id="history-content">
                 <img src="01.png" alt="標題圖示" class="title-icon">
                <h1>歷史記錄查詢</h1>
                <div class="date-filter">
                    <div class="date-input-group">
                        <div class="date-input-row">
                            <label for="start-date">開始日期：</label>
                            <input type="date" id="start-date">
                        </div>
                        <div class="date-input-row">
                            <label for="end-date">結束日期：</label>
                            <input type="date" id="end-date">
                        </div>
                    </div>
                    <div class="search-button-container">
                        <button id="search-btn">查詢</button>
                    </div>
                </div>
                <div class="history-container">
                    <table class="history-table" id="history-table">
                        <thead>
                            <tr>
                                <th>日期時間</th>
                                <th>司機</th>
                                <th>配送點</th>
                                <th>載具</th>
                                <th>數量</th>
                            </tr>
                        </thead>
                        <tbody id="history-tbody">
                        </tbody>
                    </table>
                </div>
                <p id="history-message"></p>
                <p class="designer-info">Designed by T.C.C.管理本部</p>
            </div>
        </div>
    </div>

    <!-- 更改密碼模態框 -->
    <div id="change-password-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>更改密碼</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="current-password">目前密碼</label>
                    <input type="password" id="current-password" placeholder="請輸入目前密碼">
                </div>
                <div class="form-group">
                    <label for="new-password">新密碼</label>
                    <input type="password" id="new-password" placeholder="請輸入新密碼">
                </div>
                <div class="form-group">
                    <label for="confirm-password">確認新密碼</label>
                    <input type="password" id="confirm-password" placeholder="請再次輸入新密碼">
                </div>
                <div class="button-group">
                    <button id="save-password-btn">儲存</button>
                    <button id="cancel-password-btn">取消</button>
                </div>
                <p id="password-error" class="error-message"></p>
                <p id="password-message" class="message"></p>
            </div>
        </div>
    </div>

    <script>
        // 全域變數
        let currentUser = '';
        let logoutTimer;
        const LOGOUT_TIME = 10 * 60 * 1000; // 10分鐘
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw3wll2Q4J73wsA8f5aUTyA811oFpl5303xZ3cTM0JwxmPy0NAi7usatdNUqftMt5ME/exec';

        // DOM 元素
        const loginContainer = document.getElementById('login-container');
        const deliveryContainer = document.getElementById('delivery-container');
        const welcomeMessage = document.getElementById('welcome-message');
        
        // 標籤頁相關
        const tabForm = document.getElementById('tab-form');
        const tabHistory = document.getElementById('tab-history');
        const formContent = document.getElementById('form-content');
        const historyContent = document.getElementById('history-content');
        
        // 表單元素
        const deliveryLocationInput = document.getElementById('delivery-location');
        const submitBtn = document.getElementById('submit-btn');
        const resetBtn = document.getElementById('reset-btn');
        const formMessage = document.getElementById('form-message');
        const formError = document.getElementById('form-error');
        
        // 歷史記錄相關
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const searchBtn = document.getElementById('search-btn');
        const historyTable = document.getElementById('history-table');
        const historyTbody = document.getElementById('history-tbody');
        const historyMessage = document.getElementById('history-message');
        
        // 登入相關
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const loginError = document.getElementById('login-error');
        
        // 密碼更改相關
        const changePasswordBtn = document.getElementById('change-password-btn');
        const changePasswordModal = document.getElementById('change-password-modal');
        const closeModal = document.querySelector('.close');
        const currentPasswordInput = document.getElementById('current-password');
        const newPasswordInput = document.getElementById('new-password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const savePasswordBtn = document.getElementById('save-password-btn');
        const cancelPasswordBtn = document.getElementById('cancel-password-btn');
        const passwordError = document.getElementById('password-error');
        const passwordMessage = document.getElementById('password-message');
        
        // 登出按鈕
        const logoutBtn = document.getElementById('logout-btn');

        // 展開按鈕相關
        const expandProductBtn = document.getElementById('expand-product-btn');
        const expandEmptyBtn = document.getElementById('expand-empty-btn');
        const productExpandable = document.getElementById('product-expandable');
        const emptyExpandable = document.getElementById('empty-expandable');

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 設定預設日期
            const today = new Date();
            const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            startDateInput.value = oneWeekAgo.toISOString().split('T')[0];
            endDateInput.value = today.toISOString().split('T')[0];
            
            // 載入下拉選單資料
            loadDropdownData();
            
            // 綁定事件監聽器
            bindEventListeners();
        });

        // 綁定事件監聽器
        function bindEventListeners() {
            // 登入相關
            loginBtn.addEventListener('click', handleLogin);
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });
            
            // 標籤頁切換
            tabForm.addEventListener('click', () => switchTab('form'));
            tabHistory.addEventListener('click', () => switchTab('history'));
            
            // 表單相關
            submitBtn.addEventListener('click', handleSubmit);
            resetBtn.addEventListener('click', handleReset);
            
            // 歷史記錄查詢
            searchBtn.addEventListener('click', handleSearch);
            
            // 密碼更改相關
            changePasswordBtn.addEventListener('click', showChangePasswordModal);
            closeModal.addEventListener('click', hideChangePasswordModal);
            savePasswordBtn.addEventListener('click', handleChangePassword);
            cancelPasswordBtn.addEventListener('click', hideChangePasswordModal);
            
            // 點擊模態框外部關閉
            window.addEventListener('click', function(event) {
                if (event.target === changePasswordModal) {
                    hideChangePasswordModal();
                }
            });
            
            // 登出
            logoutBtn.addEventListener('click', handleLogout);
            
            // 活動檢測
            document.addEventListener('mousemove', resetLogoutTimer);
            document.addEventListener('keypress', resetLogoutTimer);
            document.addEventListener('click', resetLogoutTimer);

            // 展開按鈕事件
            expandProductBtn.addEventListener('click', function() {
                toggleExpandableSection(productExpandable, expandProductBtn);
            });

            expandEmptyBtn.addEventListener('click', function() {
                toggleExpandableSection(emptyExpandable, expandEmptyBtn);
            });
        }

        // 切換可展開區域
        function toggleExpandableSection(section, button) {
            if (section.classList.contains('expanded')) {
                section.classList.remove('expanded');
                button.innerHTML = '▼ 展開更多組別';
            } else {
                section.classList.add('expanded');
                button.innerHTML = '▲ 收起組別';
            }
        }

        // 載入下拉選單資料
        function loadDropdownData() {
            const callbackName = 'loadDropdownCallback_' + Date.now();
            
            window[callbackName] = function(data) {
                if (data.success) {
                    // 載入配送點資料
                    const deliveryLocations = document.getElementById('delivery-locations');
                    deliveryLocations.innerHTML = '';
                    data.deliveryLocations.forEach(location => {
                        const option = document.createElement('option');
                        option.value = location;
                        deliveryLocations.appendChild(option);
                    });
                    
                    // 載入載具類型資料
                    const vehicleTypes = document.getElementById('vehicle-types');
                    vehicleTypes.innerHTML = '';
                    data.vehicleTypes.forEach(vehicle => {
                        const option = document.createElement('option');
                        option.value = vehicle;
                        vehicleTypes.appendChild(option);
                    });

                    // 載入類別下拉選單資料
                    const categories = data.categories || [];
                    
                    // 商品載具類別選單
                    for (let i = 1; i <= 4; i++) {
                        const categorySelect = document.getElementById(`category-${i}`);
                        if (categorySelect) {
                            categorySelect.innerHTML = '<option value="">請選擇類別</option>';
                            categories.forEach(category => {
                                const option = document.createElement('option');
                                option.value = category;
                                option.textContent = category;
                                categorySelect.appendChild(option);
                            });
                        }
                    }

                    // 空載具回報類別選單
                    for (let i = 5; i <= 20; i++) {
                        const categorySelect = document.getElementById(`empty-category-${i}`);
                        if (categorySelect) {
                            categorySelect.innerHTML = '<option value="">請選擇類別</option>';
                            categories.forEach(category => {
                                const option = document.createElement('option');
                                option.value = category;
                                option.textContent = category;
                                categorySelect.appendChild(option);
                            });
                        }
                    }
                }
                
                // 清理全域函數
                delete window[callbackName];
                
                // 移除 script 標籤
                const script = document.getElementById(callbackName);
                if (script) {
                    script.remove();
                }
            };
            
            const script = document.createElement('script');
            script.id = callbackName;
            script.src = `${SCRIPT_URL}?action=getDropdownData&callback=${callbackName}`;
            document.head.appendChild(script);
        }

        // 登入處理
        function handleLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!username || !password) {
                loginError.textContent = '請輸入帳號和密碼';
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.classList.add('loading');
            loginError.textContent = '';
            
            const callbackName = 'loginCallback_' + Date.now();
            
            window[callbackName] = function(data) {
                loginBtn.disabled = false;
                loginBtn.classList.remove('loading');
                
                if (data.success) {
                    currentUser = data.driverName;
                    welcomeMessage.textContent = `歡迎，${currentUser}`;
                    loginContainer.classList.add('hidden');
                    deliveryContainer.classList.remove('hidden');
                    startLogoutTimer();
                } else {
                    loginError.textContent = data.message || '登入失敗';
                }
                
                // 清理
                delete window[callbackName];
                const script = document.getElementById(callbackName);
                if (script) script.remove();
            };
            
            const script = document.createElement('script');
            script.id = callbackName;
            script.src = `${SCRIPT_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&callback=${callbackName}`;
            document.head.appendChild(script);
        }

        // 切換標籤頁
        function switchTab(tab) {
            if (tab === 'form') {
                tabForm.classList.add('active');
                tabHistory.classList.remove('active');
                formContent.classList.add('active');
                historyContent.classList.remove('active');
            } else {
                tabHistory.classList.add('active');
                tabForm.classList.remove('active');
                historyContent.classList.add('active');
                formContent.classList.remove('active');
            }
        }

        // 收集表單資料
        function collectFormData() {
            const data = {
                deliveryLocation: deliveryLocationInput.value.trim(),
                items: []
            };

            // 收集商品載具資料 (1-4)
            for (let i = 1; i <= 4; i++) {
                const category = document.getElementById(`category-${i}`)?.value.trim();
                const vehicle = document.getElementById(`vehicle-${i}`)?.value.trim();
                const quantity = document.getElementById(`quantity-${i}`)?.value.trim();
                
                if (category || vehicle || quantity) {
                    data.items.push({
                        type: '商品載具',
                        category: category || '',
                        vehicle: vehicle || '',
                        quantity: quantity || '0'
                    });
                }
            }

            // 收集空載具回報資料 (5-20)
            for (let i = 5; i <= 20; i++) {
                const category = document.getElementById(`empty-category-${i}`)?.value.trim();
                const vehicle = document.getElementById(`empty-vehicle-${i}`)?.value.trim();
                const quantity = document.getElementById(`empty-quantity-${i}`)?.value.trim();
                
                if (category || vehicle || quantity) {
                    data.items.push({
                        type: '空載具回報',
                        category: category || '',
                        vehicle: vehicle || '',
                        quantity: quantity || '0'
                    });
                }
            }

            return data;
        }

        // 提交處理
        function handleSubmit() {
            const formData = collectFormData();
            
            if (!formData.deliveryLocation) {
                formError.textContent = '請輸入配送點簡稱';
                return;
            }
            
            if (formData.items.length === 0) {
                formError.textContent = '請至少填寫一項載具資訊';
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.classList.add('loading');
            formError.textContent = '';
            formMessage.textContent = '';
            
            const callbackName = 'submitDataCallback_' + Date.now();
            
            window[callbackName] = function(data) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');
                
                if (data.success) {
                    formMessage.textContent = '資料提交成功！';
                    handleReset();
                } else {
                    formError.textContent = data.message || '提交失敗，請重試';
                }
                
                // 清理
                delete window[callbackName];
                const script = document.getElementById(callbackName);
                if (script) script.remove();
            };
            
            const script = document.createElement('script');
            script.id = callbackName;
            
            const params = new URLSearchParams({
                action: 'submitData',
                driver: currentUser,
                deliveryLocation: formData.deliveryLocation,
                data: JSON.stringify(formData.items),
                callback: callbackName
            });
            
                        script.src = `${SCRIPT_URL}?${params.toString()}`;
            document.head.appendChild(script);
        }

        // 重設表單
        function handleReset() {
            // 重設配送點
            deliveryLocationInput.value = '';
            
            // 重設商品載具 (1-4)
            for (let i = 1; i <= 4; i++) {
                const categorySelect = document.getElementById(`category-${i}`);
                const vehicleInput = document.getElementById(`vehicle-${i}`);
                const quantityInput = document.getElementById(`quantity-${i}`);
                
                if (categorySelect) categorySelect.value = '';
                if (vehicleInput) vehicleInput.value = '';
                if (quantityInput) quantityInput.value = '';
            }
            
            // 重設空載具回報 (5-20)
            for (let i = 5; i <= 20; i++) {
                const categorySelect = document.getElementById(`empty-category-${i}`);
                const vehicleInput = document.getElementById(`empty-vehicle-${i}`);
                const quantityInput = document.getElementById(`empty-quantity-${i}`);
                
                if (categorySelect) categorySelect.value = '';
                if (vehicleInput) vehicleInput.value = '';
                if (quantityInput) quantityInput.value = '';
            }
            
            // 收起展開區域
            productExpandable.classList.remove('expanded');
            emptyExpandable.classList.remove('expanded');
            expandProductBtn.innerHTML = '▼ 展開更多組別';
            expandEmptyBtn.innerHTML = '▼ 展開更多組別';
            
            // 清除訊息
            formMessage.textContent = '';
            formError.textContent = '';
        }

        // 歷史記錄查詢
        function handleSearch() {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            
            if (!startDate || !endDate) {
                historyMessage.textContent = '請選擇查詢日期範圍';
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                historyMessage.textContent = '開始日期不能晚於結束日期';
                return;
            }
            
            searchBtn.disabled = true;
            searchBtn.classList.add('loading');
            historyMessage.textContent = '查詢中...';
            
            const callbackName = 'searchHistoryCallback_' + Date.now();
            
            window[callbackName] = function(data) {
                searchBtn.disabled = false;
                searchBtn.classList.remove('loading');
                
                if (data.success) {
                    displayHistoryData(data.records);
                    historyMessage.textContent = data.records.length > 0 ? 
                        `找到 ${data.records.length} 筆記錄` : '查無資料';
                } else {
                    historyMessage.textContent = data.message || '查詢失敗';
                    historyTbody.innerHTML = '';
                }
                
                // 清理
                delete window[callbackName];
                const script = document.getElementById(callbackName);
                if (script) script.remove();
            };
            
            const script = document.createElement('script');
            script.id = callbackName;
            script.src = `${SCRIPT_URL}?action=getHistory&driver=${encodeURIComponent(currentUser)}&startDate=${startDate}&endDate=${endDate}&callback=${callbackName}`;
            document.head.appendChild(script);
        }

        // 顯示歷史記錄
        function displayHistoryData(records) {
            historyTbody.innerHTML = '';
            
            records.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.datetime}</td>
                    <td>${record.driver}</td>
                    <td>${record.deliveryLocation}</td>
                    <td>${record.vehicle}</td>
                    <td>${record.quantity}</td>
                `;
                historyTbody.appendChild(row);
            });
        }

        // 顯示更改密碼模態框
        function showChangePasswordModal() {
            changePasswordModal.classList.remove('hidden');
            currentPasswordInput.value = '';
            newPasswordInput.value = '';
            confirmPasswordInput.value = '';
            passwordError.textContent = '';
            passwordMessage.textContent = '';
        }

        // 隱藏更改密碼模態框
        function hideChangePasswordModal() {
            changePasswordModal.classList.add('hidden');
        }

        // 更改密碼處理
        function handleChangePassword() {
            const currentPassword = currentPasswordInput.value.trim();
            const newPassword = newPasswordInput.value.trim();
            const confirmPassword = confirmPasswordInput.value.trim();
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                passwordError.textContent = '請填寫所有欄位';
                return;
            }
            
            if (newPassword !== confirmPassword) {
                passwordError.textContent = '新密碼與確認密碼不一致';
                return;
            }
            
            if (newPassword.length < 6) {
                passwordError.textContent = '新密碼至少需要6個字元';
                return;
            }
            
            savePasswordBtn.disabled = true;
            savePasswordBtn.classList.add('loading');
            passwordError.textContent = '';
            passwordMessage.textContent = '';
            
            const callbackName = 'changePasswordCallback_' + Date.now();
            
            window[callbackName] = function(data) {
                savePasswordBtn.disabled = false;
                savePasswordBtn.classList.remove('loading');
                
                if (data.success) {
                    passwordMessage.textContent = '密碼更改成功！';
                    setTimeout(() => {
                        hideChangePasswordModal();
                    }, 2000);
                } else {
                    passwordError.textContent = data.message || '密碼更改失敗';
                }
                
                // 清理
                delete window[callbackName];
                const script = document.getElementById(callbackName);
                if (script) script.remove();
            };
            
            const script = document.createElement('script');
            script.id = callbackName;
            
            const params = new URLSearchParams({
                action: 'changePassword',
                username: currentUser,
                currentPassword: currentPassword,
                newPassword: newPassword,
                callback: callbackName
            });
            
            script.src = `${SCRIPT_URL}?${params.toString()}`;
            document.head.appendChild(script);
        }

        // 登出處理
        function handleLogout() {
            if (confirm('確定要登出嗎？')) {
                currentUser = '';
                clearLogoutTimer();
                deliveryContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                
                // 清除表單
                usernameInput.value = '';
                passwordInput.value = '';
                loginError.textContent = '';
                handleReset();
                
                // 切換回表單標籤頁
                switchTab('form');
            }
        }

        // 啟動登出計時器
        function startLogoutTimer() {
            clearLogoutTimer();
            logoutTimer = setTimeout(() => {
                alert('由於長時間無操作，系統將自動登出');
                handleLogout();
            }, LOGOUT_TIME);
        }

        // 重設登出計時器
        function resetLogoutTimer() {
            if (currentUser) {
                startLogoutTimer();
            }
        }

        // 清除登出計時器
        function clearLogoutTimer() {
            if (logoutTimer) {
                clearTimeout(logoutTimer);
                logoutTimer = null;
            }
        }

        // 防止表單重複提交
        function preventDoubleSubmit(button) {
            button.disabled = true;
            setTimeout(() => {
                button.disabled = false;
            }, 2000);
        }

        // 錯誤處理
        window.addEventListener('error', function(e) {
            console.error('JavaScript Error:', e.error);
        });

        // 處理 JSONP 錯誤
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Promise Rejection:', e.reason);
        });
    </script>
</body>
</html>
