            });
            
            fetch(`https://script.google.com/macros/s/AKfycbxkYpQWSU3AJ3SRSwWkNd2JBrwxu5VZrXLEpDppth0dRWwFErqgeCFro2xcfkAukOvu/exec?${params}`)
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        displayHistoryResults(data.data);
                    } else {
                        showMessage('查詢失敗：' + data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('查詢錯誤:', error);
                    hideLoading();
                    showMessage('查詢時發生錯誤', 'error');
                });
        }
        
        // 顯示歷史記錄結果
        function displayHistoryResults(data) {
            const resultsDiv = document.getElementById('historyResults');
            
            if (!data || data.length === 0) {
                resultsDiv.innerHTML = '<p style="text-align: center; color: #666;">查無資料</p>';
                return;
            }
            
            let tableHTML = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>配送日期</th>
                            <th>司機姓名</th>
                            <th>配送點簡稱</th>
                            <th>類別1</th>
                            <th>載具簡稱1</th>
                            <th>數量1</th>
                            <th>類別2</th>
                            <th>載具簡稱2</th>
                            <th>數量2</th>
                            <th>類別3</th>
                            <th>載具簡稱3</th>
                            <th>數量3</th>
                            <th>類別4</th>
                            <th>載具簡稱4</th>
                            <th>數量4</th>
                            <th>類別5</th>
                            <th>載具簡稱5</th>
                            <th>數量5</th>
                            <th>類別6</th>
                            <th>載具簡稱6</th>
                            <th>數量6</th>
                            <th>類別7</th>
                            <th>載具簡稱7</th>
                            <th>數量7</th>
                            <th>類別8</th>
                            <th>載具簡稱8</th>
                            <th>數量8</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(row => {
                tableHTML += '<tr>';
                tableHTML += `<td>${row.配送日期 || ''}</td>`;
                tableHTML += `<td>${row.司機姓名 || ''}</td>`;
                tableHTML += `<td>${row.配送點簡稱 || ''}</td>`;
                for (let i = 1; i <= 8; i++) {
                    tableHTML += `<td>${row[`類別${i}`] || ''}</td>`;
                    tableHTML += `<td>${row[`載具簡稱${i}`] || ''}</td>`;
                    tableHTML += `<td>${row[`數量${i}`] || ''}</td>`;
                }
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            resultsDiv.innerHTML = tableHTML;
        }
        
        // 密碼變更表單提交
        document.getElementById('passwordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showMessage('新密碼與確認密碼不相符', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showMessage('新密碼長度至少需要6個字元', 'error');
                return;
            }
            
            showLoading('正在更改密碼...');
            
            const data = {
                action: 'changePassword',
                driverName: currentUser.name,
                currentPassword: currentPassword,
                newPassword: newPassword
            };
            
            fetch('https://script.google.com/macros/s/AKfycbwVZBXN7yvNmFVPxPfgXIBQJOKOGdYDNEBr9oRNEaKQGbE9XGpWGjXNJNdTMhZLHNJJ/exec', {
                method: 'POST',
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                hideLoading();
                if (result.success) {
                    showMessage('密碼更改成功！', 'success');
                    document.getElementById('passwordForm').reset();
                } else {
                    showMessage('密碼更改失敗：' + result.message, 'error');
                }
            })
            .catch(error => {
                console.error('密碼更改錯誤:', error);
                hideLoading();
                showMessage('密碼更改時發生錯誤', 'error');
            });
        });
        
        // 顯示訊息
        function showMessage(message, type) {
            const messageDiv = document.querySelector('.content.active .message') || 
                              document.querySelector('.content.active #deliveryMessage') ||
                              document.querySelector('.content.active #passwordMessage');
            
            if (messageDiv) {
                messageDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 5000);
            }
        }
        
        // 顯示載入中
        function showLoading(message) {
            const activeContent = document.querySelector('.content.active');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.id = 'loadingIndicator';
            loadingDiv.innerHTML = `
                <div class="spinner"></div>
                <p>${message}</p>
            `;
            activeContent.appendChild(loadingDiv);
        }
        
        // 隱藏載入中
        function hideLoading() {
            const loadingDiv = document.getElementById('loadingIndicator');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }
        
        // 登出功能
        function logout() {
            localStorage.removeItem('userData');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
